<story-context id=".bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>1</epicId>
    <storyId>1.3</storyId>
    <title>Create &amp; Submit Shift Report</title>
    <status>drafted</status>
    <generatedAt>2025-12-02</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>sprint-artifacts/1-3-create-submit-shift-report.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>a Shift Leader</asA>
    <iWant>an intuitive form to create and submit a new shift report</iWant>
    <soThat>I can accurately capture my daily operational data with minimal effort.</soThat>
    <tasks>
- [ ] Task 1 (AC: #)
  - [ ] Subtask 1.1
- [ ] Task 2 (AC: #)
  - [ ] Subtask 2.1
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion>A logged-in Shift Leader can access an intuitive form to create and submit a new shift report.</criterion>
    <criterion>The form provides real-time validation for numeric inputs, with error states as defined in the UX spec.</criterion>
    <criterion>When they click "Submit", the report data is saved to the `reports` table in the Supabase database.</criterion>
    <criterion>A success notification is displayed upon successful submission.</criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
        <doc path="docs/PRD.md" title="Product Requirements Document" section="Product Scope" snippet="Create, read, and update shift reports via validated form. Field validation (e.g., required numeric inputs, date logic)."/>
        <doc path="docs/PRD.md" title="Product Requirements Document" section="Functional Requirements" snippet="Users shall be able to create, read, update, and submit daily shift reports through a validated form."/>
        <doc path="sprint-artifacts/tech-spec-epic-1.md" title="Technical Specification: Epic 1" section="Story 1.3: Create &amp; Submit Shift Report" snippet="A logged-in Shift Leader can access an intuitive form to create and submit a new shift report... The form provides real-time validation for numeric inputs."/>
        <doc path="sprint-artifacts/tech-spec-epic-1.md" title="Technical Specification: Epic 1" section="Technical Requirements" snippet="Data Model Fields: reports table... Validation Rules (from PRD.md)... API Endpoint: POST /api/reports... UI Elements: Tailwind CSS, ShadCN/UI."/>
        <doc path="docs/architecture.md" title="Architecture" section="Decision Summary" snippet="API Pattern: Next.js Route Handlers + Direct Supabase Client... UI Components: Shadcn/UI (recommended)."/>
        <doc path="docs/architecture.md" title="Architecture" section="Project Structure" snippet="src/app/(app)/reports/new/ page.tsx; src/app/api/reports/ route.ts; src/components/ShiftReportForm component."/>
        <doc path="docs/architecture.md" title="Architecture" section="Security Architecture" snippet="Row Level Security (RLS) policies will be heavily used to enforce data access rules... API endpoints... will be protected, validating the user's JWT."/>
        <doc path="docs/architecture.md" title="Architecture" section="Data Architecture" snippet="High-level data model... `reports` table: The core table for shift reports, with foreign keys to the `users` table."/>
        <doc path="docs/architecture.md" title="Architecture" section="Consistency Rules" snippet="Error Handling: Structured JSON error responses... Date/Time Handling: All date and time values will be stored in UTC."/>
    </docs>
    <code>
        <code path="sg-ostfold-app/src/lib/supabase.ts" kind="library" symbol="supabase" reason="Supabase client for database interaction and authentication checks."/>
        <code path="sg-ostfold-app/src/app/(app)/reports/new/page.tsx" kind="page" reason="To be created: UI for the shift report form."/>
        <code path="sg-ostfold-app/src/components/reports/ShiftReportForm.tsx" kind="component" reason="To be created: Reusable form component for report submission."/>
        <code path="sg-ostfold-app/src/app/api/reports/route.ts" kind="api-route" reason="To be created: Backend API endpoint for receiving and processing shift reports."/>
    </code>
    <dependencies>
        <dependency name="@supabase/supabase-js" version="^2.86.0"/>
        <dependency name="next" version="16.0.6"/>
        <dependency name="react" version="19.2.0"/>
        <dependency name="react-dom" version="19.2.0"/>
        <dependency name="class-variance-authority" version="^0.7.1"/>
        <dependency name="clsx" version="^2.1.1"/>
        <dependency name="date-fns" version="^4.1.0"/>
        <dependency name="lucide-react" version="^0.555.0"/>
        <dependency name="tailwind-merge" version="^3.4.0"/>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint>UI must adhere to dark-mode theme specified in `ux-design-specification.md`.</constraint>
    <constraint>Client-side validation using Zod schema definition.</constraint>
    <constraint>Server-side validation in API Route Handler.</constraint>
    <constraint>API communication follows patterns in `architecture.md` (Next.js Route Handlers).</constraint>
    <constraint>Database interaction uses Supabase client (`supabase.from('reports').insert(...)`).</constraint>
    <constraint>Security: API route protected, accessible only by authenticated users with 'shift_leader' role (RLS from Story 1.1).</constraint>
    <constraint>Date and time values stored in UTC in PostgreSQL `timestamp with time zone`.</constraint>
  </constraints>
  <interfaces>
    <interface name="Shift Report Submission API" kind="REST endpoint" signature="POST /api/reports" path="sg-ostfold-app/src/app/api/reports/route.ts"/>
  </interfaces>
  <tests>
    <standards>
        <standard>Layered Testing Strategy: Unit Tests (Jest, React Testing Library), Integration Tests (Jest), E2E Tests (Playwright).</standard>
        <standard>CI/CD Integration: All tests run automatically in CI/CD pipeline on Vercel.</standard>
    </standards>
    <locations>
        <location>src/app/(app)/reports/new/page.test.tsx (Unit Tests for client-side validation)</location>
        <location>src/app/api/reports/route.test.ts (Integration Tests for API Route Handler)</location>
        <location>tests/e2e/report-submission.spec.ts (E2E Tests for full user flow)</location>
    </locations>
    <ideas>
      <idea for="AC1">Unit Tests: Test the client-side form validation logic (e.g., Zod schema validation).</idea>
      <idea for="AC2">Integration Tests: CRITICAL: Write integration tests for the `POST /api/reports` API Route Handler to ensure correct server-side validation, data insertion, and authorization.</idea>
      <idea for="AC3">End-to-End (E2E) Tests: A test case for a successful form submission by a logged-in Shift Leader, asserting data persistence and success notification.</idea>
      <idea for="AC4">End-to-End (E2E) Tests: A test case for attempted submission with invalid data, asserting validation errors.</idea>
      <idea for="AC4">End-to-End (E2E) Tests: A test case for an unauthenticated user attempting to access the form, asserting redirection to `/login`.</idea>
    </ideas>
  </tests>
</story-context>

# Story S-2.1: User Login - Implementation Plan

## 1. Story Summary

This story focuses on implementing the core user login functionality for the application. As a user, I need a dedicated login page (`/auth/login`) where I can securely authenticate with my email and password. Upon successful login, I will be redirected to the main dashboard. This feature is critical for securing the application, enabling personalized experiences, and providing the foundational authentication layer for all subsequent user-specific features. The implementation will leverage Supabase Auth for robust session and JWT handling, ensuring a seamless and secure user experience across the application.

## 2. Detailed Requirements

### 2.1 UI Requirements for `/auth/login` Page (Reference: `docs/ux-design-specification.md`)

*   **Route:** Implement the login page at `/auth/login` using Next.js App Router's `app/(auth)/login/page.tsx` structure.
*   **Design:** The UI must adhere to the existing design specification for typography, spacing, inputs, buttons, error states, and overall visual identity (dark-mode first).
*   **Form Fields:**
    *   **Email:** Required field. Must validate for correct email format on client-side (e.g., using Zod).
    *   **Password:** Required field.
*   **UI Behaviors:**
    *   **Loading State:** The "Log in" button must be disabled and display a loading indicator (e.g., spinner) while the login request is in progress.
    *   **Error State:** Display clear, inline error messages for invalid login attempts (e.g., "Invalid email or password", "Email not found"). System/API errors should also be displayed prominently. (Reference: `docs/ux-design-specification.md` - Form Patterns, Error Display)
*   **Accessibility (Reference: `docs/ux-design-specification.md` - Accessibility Strategy):**
    *   Ensure proper `<label>` associations for all input fields.
    *   Implement visible focus states for inputs and buttons to support keyboard navigation.
    *   Comply with WCAG 2.1 Level AA standards.
*   **Optional:** A placeholder link for "Forgot password" can be included but does not need to be functional for this story.

### 2.2 Frontend Logic: `useAuth` Hook (`src/hooks/useAuth.ts`)

*   **Technology:** Implement using the official Supabase Auth client (`@supabase/supabase-js`).
*   **Exposed State & Functions:** The hook must expose at least the following:
    *   `currentUser`: Object representing the currently authenticated user (or `null`).
    *   `session`: Object representing the current Supabase session (or `null`).
    *   `login(credentials: { email: string; password: string })`: Function to initiate the login process.
    *   `logout()`: Function to terminate the current session.
    *   `isLoading`: Boolean state indicating if an authentication operation is in progress.
    *   `isAuthenticated`: Boolean state (`!!session`).
*   **Authentication Flow:**
    *   **Success:** On successful login, update the global authentication state (`currentUser`, `session`, `isAuthenticated`). Trigger client-side navigation to the `/dashboard` route.
    *   **Failure:** On failed login, return or throw a structured error that can be caught and displayed by the UI component (e.g., `login/page.tsx`).

### 2.3 JWT/Session Handling & Auth State Synchronization

*   **Mechanism:** Leverage Supabase's recommended session management and auth state listeners to handle JWT/session persistence in the browser.
*   **Initialization:** Implement logic to detect and initialize the global auth state based on an existing session (`supabase.auth.getSession()`) on application startup.
*   **Synchronization:** Keep the global auth state synchronized with Supabase events (e.g., `onAuthStateChange` for login, logout, token refresh).

### 2.4 Redirect Rules & Protected Routes

*   **Authenticated Users on Login Page:** If an authenticated user attempts to access `/auth/login`, they must be redirected to `/dashboard`.
*   **Unauthenticated Users on Protected Pages:** If an unauthenticated user attempts to access any protected page (e.g., `/dashboard`), they must be redirected to `/auth/login`.
*   **Implementation:** Consider implementing an "AuthGuard" component or a higher-level routing logic (e.g., Next.js middleware) to enforce these rules. (Reference: `docs/architecture.md` - Frontend Architecture)

### 2.5 Technical Constraints, Dependencies, and Assumptions

*   **Authentication Provider:** Supabase Auth (email/password).
*   **Frontend Framework:** Next.js (App Router), React, TypeScript.
*   **Styling:** Tailwind CSS, Shadcn/ui components.
*   **Validation:** Client-side form validation (e.g., using Zod for email format).
*   **Dependencies:** `@supabase/supabase-js`, `next`, `react`, `zod`.
*   **Assumptions:** A Supabase project is already set up and configured for email/password authentication (S-1.3). The `/dashboard` route exists.

## 3. Acceptance Criteria

*   **UI (AC1):**
    *   The `/auth/login` page exists and its UI matches the design specification.
    *   Loading states (disabled button with spinner) are correctly displayed during login attempts.
    *   Error messages for invalid login attempts are clearly visible and dismissible.
*   **Auth Flow (AC2):**
    *   Users can successfully log in with valid email and password credentials via Supabase.
    *   Upon successful login, the user is automatically redirected to the `/dashboard`.
    *   Authenticated users attempting to navigate to `/auth/login` are redirected to `/dashboard`.
    *   Unauthenticated users attempting to access protected pages (e.g., `/dashboard`) are redirected to `/auth/login`.
*   **JWT/Session (AC3):**
    *   Supabase session and JWT are correctly stored in the browser and persist across page reloads (while tokens are valid).
    *   The authentication state (`isAuthenticated`, `currentUser`, `session`) is correctly initialized on application load.
    *   The authentication state synchronizes correctly with Supabase events (e.g., on login, logout, token refresh).
*   **Testing (AC4):**
    *   A Playwright E2E test for the happy path (successful login and redirect) is implemented and passes.
    *   A Playwright E2E test for invalid credentials (error message displayed, no redirection) is implemented and passes.

## 4. Tasks / Subtasks

### 4.1 UI Implementation (`src/app/(auth)/login/page.tsx`)

*   [x] Create the `/auth/login` route and page component.
*   [x] Implement the basic login form layout using Shadcn/ui components (Input, Button).
*   [x] Add email and password input fields.
*   [x] Integrate client-side validation for email format and required fields.
*   [x] Implement loading state UI (disable button, add spinner) during login requests.
*   [x] Implement error display UI for failed login attempts.
*   [x] Ensure proper `<label>` association and visible focus states for accessibility.
*   [ ] (Optional) Add a "Forgot password" placeholder link.

### 4.2 Auth Hook Implementation (`src/hooks/useAuth.ts`)

*   [x] Create `src/hooks/useAuth.ts`.
*   [x] Initialize Supabase client within the hook.
*   [x] Implement `login(email, password)` function using `supabase.auth.signInWithPassword`.
*   [x] Implement `logout()` function using `supabase.auth.signOut`.
*   [x] Manage `isLoading`, `currentUser`, `session`, and `isAuthenticated` states using React's `useState` and `useEffect`.
*   [x] Subscribe to Supabase `onAuthStateChange` events to keep internal state synchronized.

### 4.3 Route Guards / Redirects (Next.js App Router)

*   [x] Implement a mechanism to redirect authenticated users from `/auth/login` to `/dashboard`. (Consider: middleware, component-level logic).
*   [x] Implement a mechanism to redirect unauthenticated users from protected routes (e.g., `/dashboard`) to `/auth/login`. (Consider: middleware, higher-order components, or `layout.tsx` logic).

### 4.4 JWT/Session Handling

*   [x] Verify `supabase-js` correctly handles JWT storage (e.g., in browser cookies or local storage).
*   [x] Ensure the global auth state is rehydrated from the session on page load.

### 4.5 End-to-End Testing (`e2e/auth.spec.ts`)

*   [x] Set up Playwright test file (`e2e/auth.spec.ts`).
*   [x] Write E2E test for successful login:
    *   Navigate to `/auth/login`.
    *   Fill in valid email and password.
    *   Click "Log in".
    *   Assert redirection to `/dashboard`.
    *   Assert presence of dashboard-specific UI elements.
*   [x] Write E2E test for failed login:
    *   Navigate to `/auth/login`.
    *   Fill in invalid email and password.
    *   Click "Log in".
    *   Assert error message is displayed.
    *   Assert no redirection occurs.
*   [x] Write E2E tests for redirect rules (authenticated user on login page, unauthenticated user on protected page).
*   [x] Write E2E test for logout functionality (added in dashboard placeholder).

### 4.6 Setup & Refactoring

*   [x] Ensure `supabase/client.ts` is correctly configured and accessible.
*   [x] Add necessary environment variables for Supabase keys if not already present.

## 5. Definition of Done

*   [ ] All Acceptance Criteria (AC1-AC4) are met and verified.
*   [ ] The `/auth/login` page is implemented, functional, and matches design specifications.
*   [ ] The `useAuth` hook is implemented, provides required functionality and state, and is tested.
*   [ ] JWT/session handling and auth state synchronization are robust.
*   [ ] Redirect rules for authenticated/unauthenticated users are correctly implemented and enforced.
*   [ ] All automated tests (E2E) pass 100%.
*   [ ] Code is clean, well-commented, and adheres to project coding standards.
*   [ ] No new linter warnings or errors introduced.
*   [ ] Code has been reviewed and approved (will be covered by `code-review` workflow).
*   [ ] Updated `sprint-status.yaml` reflects story completion.

## 6. Risks / Edge Cases

*   **Invalid Credentials:** Handled by displaying an error message without redirection.
*   **Network Issues:** `useAuth` hook should handle network errors gracefully, providing feedback to the user.
*   **Session Expiration/Invalid Tokens:** `useAuth` and Supabase client should automatically handle token refresh. If refresh fails (e.g., refresh token revoked), the user should be logged out and redirected to `/auth/login`.
*   **User Already Logged In:** Handled by redirecting to `/dashboard`.
*   **Protected Route Access without Auth:** Handled by redirecting to `/auth/login`.
*   **Supabase Configuration:** Incorrect or missing Supabase environment variables could lead to authentication failures.
*   **Security Vulnerabilities:** Ensure all inputs are sanitized to prevent XSS/injection attacks, although Supabase Auth handles much of this.
*   **Race Conditions:** Ensure state updates and redirects don't lead to race conditions, especially with concurrent authentication events or quick navigation.

## Dev Agent Record

### Context Reference
- `docs/sprint-artifacts/S-2.1.context.xml`

### Agent Model Used
- Developer Agent (Amelia)

### Debug Log References
- N/A (Initial implementation plan)

### Completion Notes List
- Implemented UI for login page (`src/app/(auth)/login/page.tsx`).
- Implemented `useAuth` hook (`src/hooks/useAuth.ts`).
- Created Supabase client utilities (`src/lib/supabase/client.ts`, `src/lib/supabase/server.ts`).
- Implemented client-side routing middleware (`middleware.ts`).
- Created placeholder Dashboard page (`src/app/(main)/dashboard/page.tsx`).
- Implemented Playwright E2E tests (`e2e/auth.spec.ts`).

### File List
- `src/app/(auth)/login/page.tsx` (new)
- `src/hooks/useAuth.ts` (new)
- `src/lib/supabase/client.ts` (new)
- `src/lib/supabase/server.ts` (new)
- `middleware.ts` (new)
- `src/app/(main)/dashboard/page.tsx` (new)
- `e2e/auth.spec.ts` (new)
- `playwright.config.ts` (new)

## Change Log

- Initial version of the implementation plan generated based on S-2.1.md and S-2.1.context.xml.
- Implemented UI, auth hook, routing, and E2E tests for S-2.1.

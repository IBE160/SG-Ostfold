Story ID: S-2.1
Title: User Login
Status: drafted

Context:
We need to implement user login for the web application using Supabase Auth. The feature includes a dedicated login page, a frontend auth hook, JWT/session handling, and an end-to-end test validating the login flow.

Goal:
As a user, I want to log in through a dedicated login page so that, when I enter a valid email and password, I am authenticated and redirected to the dashboard.

Requirements / Scope:

1) Frontend – Login Page UI
- Create a login page with the route: /auth/login.
- Build the UI based on the existing design specification (typography, spacing, inputs, buttons, error states).
- Form fields:
  - Email (required, validate correct email format)
  - Password (required)
- UI behaviors:
  - Disable the “Log in” button while the login request is in progress (loading state).
  - Display an error message for invalid login attempts (e.g., “Invalid email or password”).
  - Optional: a placeholder link for “Forgot password” if not implemented yet.
- Accessibility:
  - Proper label associations for inputs.
  - Visible focus states for inputs and buttons.

2) Frontend – useAuth Hook
- Implement the client logic in hooks/useAuth.ts using the Supabase Auth client.
- The hook should expose at least:
  - currentUser / session
  - login(credentials: { email: string; password: string })
  - logout()
  - isLoading
  - isAuthenticated (boolean)
- On successful login:
  - Update the global auth state.
  - Trigger navigation to /dashboard from the component using the hook.
- On failed login:
  - Return or throw an error that can be shown in the UI.
- The hook must use the official Supabase JS/TS Auth client.

3) JWT Storage and Auth State Handling
- Ensure correct handling of Supabase session/JWT in the browser (using Supabase’s recommended session management and auth state listeners).
- Implement logic to:
  - Detect an existing session on app initialization.
  - Keep global auth state in sync with Supabase events (login, logout, refresh).
- Route behavior:
  - Authenticated users visiting /auth/login should be redirected to /dashboard.
  - Unauthenticated users accessing protected pages (such as /dashboard) should be redirected to /auth/login.
- Optionally implement an "AuthGuard" component or higher-level logic for protected routes.

4) Testing – Playwright E2E
- Create a Playwright E2E test verifying that:
  - A user can navigate to /auth/login.
  - The user enters valid credentials and clicks “Log in”.
  - After successful login, the user is redirected to /dashboard.
  - The test checks:
    - The final URL is /dashboard.
    - Dashboard-specific UI elements are visible (e.g., a heading “Dashboard”).
- Negative test:
  - Invalid credentials show an error message and do NOT redirect the user.

Acceptance Criteria:

- UI:
  - /auth/login exists and matches the design specification.
  - Error and loading states work and are clearly visible.

- Auth flow:
  - Login with valid credentials using Supabase works and creates a valid session.
  - After login, the user is automatically redirected to /dashboard.
  - Authenticated users cannot access the login page.
  - Unauthenticated users cannot access protected pages.

- JWT/session:
  - Supabase session/JWT is stored and reused so the user remains logged in on page reload (while tokens are valid).
  - Auth state initializes correctly on app load.

- Testing:
  - Playwright E2E test for the happy path (successful login + redirect) is implemented and passes.
  - Playwright E2E test for invalid credentials (error state, no redirect) is implemented and passes.

Technical Notes:

### Architecture Patterns and Constraints
- **Authentication:** Utilize Supabase Auth (official JS/TS client) for all authentication flows, ensuring secure token handling and session management in the browser.
- **Frontend Stack:** Adhere to the existing project's React/Next.js and TypeScript conventions.
- **State Management:** The `useAuth` hook should provide clear `currentUser/session`, `isLoading`, and `isAuthenticated` states for consistent UI behavior.
- **Redirects:** Implement client-side redirects for authenticated users accessing the login page and unauthenticated users accessing protected routes.

### Learnings from Previous Story
- **S-1.3 Setup Supabase project and initial schema:** The story artifact for S-1.3 (`docs/sprint-artifacts/S-1.3.md`) was not found. This indicates a potential gap in story artifact management. Future stories should ensure their referenced predecessors exist.

### References (with citations)
- [Source: epics.md#E-2-authentication-user-roles] - Epic E-2 defines the scope and business value for authentication.
- [Source: architecture.md] - General system architecture, including technology stack and high-level design.
- [Source: ux-design-specification.md] - The UI should follow the design specifications for login page typography, spacing, inputs, buttons, and error states.

### Other Considerations
- **AC Traceability:** Acceptance Criteria are detailed in this story. While derived from the Epic, `epics.md` does not contain detailed ACs for direct comparison.
- **Task-AC Mapping:** For future stories, tasks could explicitly reference ACs using a format like `(AC: #{{ac_num}})` for clearer mapping.
- **Testing:** Playwright E2E tests are required for both positive and negative login flows, validating UI, authentication, and redirection.


Deliverables:
- Implemented login page (/auth/login)
- Implemented hooks/useAuth.ts with login/logout/auth state handling
- Route protection and redirect logic
- Playwright E2E tests for positive and negative login flows

## Dev Agent Record

### Context Reference
N/A

### Agent Model Used
N/A

### Debug Log References
N/A

### Completion Notes List
- N/A

### File List
- N/A

## Change Log

- Initial draft generated.

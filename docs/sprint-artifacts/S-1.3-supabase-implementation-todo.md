### **Phase 1: Supabase Project Setup & Core Configuration**

#### **1. Supabase Project Initialization**

*   **TODO 1.1:** Create a new Supabase project via the Supabase dashboard.
    *   **Details:** Go to [https://supabase.com/dashboard/projects](https://supabase.com/dashboard/projects) and create a new project. Choose a suitable region and plan (initial: free tier).
    *   **Verification:** Ensure the project is accessible in the dashboard.

*   **TODO 1.2:** Retrieve project identifier and connection string.
    *   **Details:** Navigate to "Project Settings" -> "API" in the Supabase dashboard to get the Project URL and Anon Key.
    *   **Verification:** Note down these values for next steps.

*   **TODO 1.3 (Optional but Recommended):** Rename the default `public` schema to `app_data`.
    *   **File:** Supabase SQL Editor.
    *   **Code:**
        ```sql
        ALTER SCHEMA public RENAME TO app_data;
        ```
    *   **Verification:** Confirm the schema name change in the Supabase Table Editor.

*   **TODO 1.4:** Configure project settings (e.g., region, budget limits).
    *   **Details:** Review and adjust settings in the Supabase dashboard as per project requirements.
    *   **Verification:** Confirm settings are applied.

#### **2. Environment Variable Setup**

*   **TODO 2.1:** Add `SUPABASE_URL` and `SUPABASE_ANON_KEY` to the root `.env.local` file.
    *   **File:** `/.env.local` (create if it doesn't exist).
    *   **Code:**
        ```
        SUPABASE_URL="YOUR_SUPABASE_PROJECT_URL"
        SUPABASE_ANON_KEY="YOUR_SUPABASE_ANON_KEY"
        ```
    *   **Verification:** Ensure environment variables are correctly loaded in local development environment.

*   **TODO 2.2:** Document secure integration of environment variables into CI/CD pipelines.
    *   **File:** `docs/deployment/environment-variables.md` (or similar, create if not existing).
    *   **Content:** Provide instructions for setting `SUPABASE_URL` and `SUPABASE_ANON_KEY` as secrets in CI/CD (e.g., GitHub Actions, Vercel).
    *   **Verification:** Documentation is clear and accessible.

#### **3. Authentication Configuration**

*   **TODO 3.1:** Enable Email provider in Supabase Auth settings.
    *   **Details:** Navigate to "Authentication" -> "Settings" in the Supabase dashboard. Enable "Email Signups" and configure "Confirm Email" (e.g., "ON").
    *   **Verification:** Email signups are enabled.

*   **TODO 3.2 (Optional):** Integrate and configure social login providers (e.g., Google, GitHub).
    *   **Details:** In "Authentication" -> "Providers", enable and configure desired providers with their respective client IDs and secrets.
    *   **Verification:** Social login options appear as enabled.

*   **TODO 3.3:** Customize email templates for authentication.
    *   **Details:** In "Authentication" -> "Email Templates", customize templates for welcome, password reset, and magic link as needed for branding and user experience.
    *   **Verification:** Templates are updated.

---

### **Phase 2: Initial PostgreSQL Schema & RLS Implementation**

#### **4. Initial PostgreSQL Schema Design & Implementation**

*   **TODO 4.1:** Plan `public.profiles` table schema.
    *   **Details:** This table extends `auth.users`.
    *   **Code (SQL):**
        ```sql
        CREATE TABLE IF NOT EXISTS public.profiles (
            id UUID REFERENCES auth.users(id) ON DELETE CASCADE PRIMARY KEY,
            created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
            updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
            full_name TEXT,
            avatar_url TEXT,
            role TEXT DEFAULT 'employee' CHECK (role IN ('manager', 'employee', 'admin')),
            department_id UUID REFERENCES public.departments(id) ON DELETE SET NULL -- Assuming departments table exists
        );
        -- Set up Row-Level Security (RLS) for profiles table
        ALTER TABLE public.profiles ENABLE ROW LEVEL SECURITY;
        CREATE POLICY "Individual profiles are viewable by the owner." ON public.profiles FOR SELECT USING (auth.uid() = id);
        CREATE POLICY "Users can insert their own profile." ON public.profiles FOR INSERT WITH CHECK (auth.uid() = id);
        CREATE POLICY "Users can update their own profile." ON public.profiles FOR UPDATE USING (auth.uid() = id);
        ```
    *   **Verification:** SQL is prepared for execution.

*   **TODO 4.2:** Plan `public.departments` table schema.
    *   **Code (SQL):**
        ```sql
        CREATE TABLE IF NOT EXISTS public.departments (
            id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
            name TEXT UNIQUE NOT NULL,
            created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
        );
        ALTER TABLE public.departments ENABLE ROW LEVEL SECURITY;
        -- Example policy: All authenticated users can view departments
        CREATE POLICY "All authenticated users can view departments" ON public.departments FOR SELECT USING (auth.role() = 'authenticated');
        ```
    *   **Verification:** SQL is prepared for execution.

*   **TODO 4.3:** Plan `public.employees` table schema (if distinct from `profiles`).
    *   **Details:** If `profiles` handles all employee data, this might not be needed. Assuming it is needed for distinct employee properties.
    *   **Code (SQL):**
        ```sql
        CREATE TABLE IF NOT EXISTS public.employees (
            id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
            profile_id UUID REFERENCES public.profiles(id) ON DELETE CASCADE UNIQUE,
            employee_id_number TEXT UNIQUE NOT NULL,
            hire_date DATE NOT NULL,
            -- Add other employee-specific fields
            created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
        );
        ALTER TABLE public.employees ENABLE ROW LEVEL SECURITY;
        -- Example policy: Employees can view their own record
        CREATE POLICY "Employees can view their own record" ON public.employees FOR SELECT USING (auth.uid() = profile_id);
        ```
    *   **Verification:** SQL is prepared for execution.

*   **TODO 4.4:** Plan `public.shift_reports` table schema.
    *   **Code (SQL):**
        ```sql
        CREATE TABLE IF NOT EXISTS public.shift_reports (
            id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
            employee_profile_id UUID REFERENCES public.profiles(id) ON DELETE SET NULL, -- Link to profile if employee data is in profiles
            -- OR employee_id UUID REFERENCES public.employees(id) ON DELETE SET NULL, -- Link to employees if distinct table
            start_time TIMESTAMP WITH TIME ZONE NOT NULL,
            end_time TIMESTAMP WITH TIME ZONE NOT NULL,
            notes TEXT,
            created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
            CHECK (end_time > start_time)
        );
        ALTER TABLE public.shift_reports ENABLE ROW LEVEL SECURITY;
        -- Example policy: Employees can manage their own shift reports
        CREATE POLICY "Employees can manage their own shift reports" ON public.shift_reports
        FOR ALL USING (auth.uid() = employee_profile_id) WITH CHECK (auth.uid() = employee_profile_id);
        ```
    *   **Verification:** SQL is prepared for execution.

*   **TODO 4.5:** Plan `public.kpis` table schema.
    *   **Code (SQL):**
        ```sql
        CREATE TABLE IF NOT EXISTS public.kpis (
            id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
            metric_name TEXT NOT NULL,
            value NUMERIC NOT NULL,
            recorded_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
            shift_report_id UUID REFERENCES public.shift_reports(id) ON DELETE SET NULL,
            -- Optional: Add employee_profile_id for direct linking if not always tied to a shift report
            employee_profile_id UUID REFERENCES public.profiles(id) ON DELETE SET NULL,
            created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
        );
        ALTER TABLE public.kpis ENABLE ROW LEVEL SECURITY;
        -- Example policy: Employees can view KPIs associated with their reports or profile
        CREATE POLICY "Employees can view their KPIs" ON public.kpis FOR SELECT USING (
            employee_profile_id = auth.uid() OR
            EXISTS (SELECT 1 FROM public.shift_reports sr WHERE sr.id = shift_report_id AND sr.employee_profile_id = auth.uid())
        );
        ```
    *   **Verification:** SQL is prepared for execution.

*   **TODO 4.6:** Create a single SQL script for initial schema creation.
    *   **File:** `backend/supabase/migrations/00_initial_schema.sql` (or similar, this will be generated by Supabase CLI later).
    *   **Content:** Combine all `CREATE TABLE` and `ALTER TABLE ... ENABLE RLS` and `CREATE POLICY` statements from above. Ensure correct order of table creation due to foreign key dependencies.
    *   **Verification:** Single SQL script is prepared.

*   **TODO 4.7:** Apply the initial schema SQL script to the Supabase database.
    *   **Details:** Use Supabase SQL Editor in the dashboard or `supabase db push` after CLI setup.
    *   **Verification:** Confirm all tables and policies exist in Supabase Table Editor and Authentication policies.

#### **5. Role-Based Access Policies (RLS)**

*   **TODO 5.1:** Review and refine RLS policies for `profiles`, `departments`, `employees`, `shift_reports`, and `kpis`.
    *   **Details:** Ensure each policy correctly implements the desired access control based on user roles (`auth.role()`) and ownership (`auth.uid()`). Consider policies for `INSERT`, `UPDATE`, `DELETE` in addition to `SELECT`.
    *   **Verification:** Policies are robust and secure.

*   **TODO 5.2:** Test RLS policies thoroughly.
    *   **Details:** Create test users with different roles (e.g., employee, manager) and attempt unauthorized data operations. Use `AS ROLE` in SQL queries for testing.
    *   **Verification:** Unauthorized operations are denied; authorized operations succeed.

#### **6. Database Migrations Setup**

*   **TODO 6.1:** Install Supabase CLI.
    *   **Details:** In the project root, run `pnpm install supabase --save-dev`
    *   **Verification:** Supabase CLI is installed as a dev dependency.

*   **TODO 6.2:** Initialize Supabase CLI.
    *   **Details:** In the project root, run `supabase init`.
    *   **File:** Creates `supabase/config.toml` and `supabase/migrations/` directory.
    *   **Verification:** `supabase/` directory structure is created.

*   **TODO 6.3:** Link local Supabase project to the remote project.
    *   **Details:** Run `supabase link --project-id <your-supabase-project-id>`. Replace `<your-supabase-project-id>` with the actual ID from the Supabase dashboard.
    *   **Verification:** Local project is linked to remote.

*   **TODO 6.4:** Generate the first migration script (`initial_schema`).
    *   **Details:** Run `supabase migration new initial_schema`. This will create a file like `supabase/migrations/<timestamp>_initial_schema.sql`.
    *   **File:** `supabase/migrations/<timestamp>_initial_schema.sql`.
    *   **Content:** Copy the SQL script from **TODO 4.6** into this newly generated migration file.
    *   **Verification:** Migration file is created and contains the full schema.

*   **TODO 6.5:** Apply the migration to the local development database (if applicable).
    *   **Details:** Run `supabase db reset` or `supabase db push`.
    *   **Verification:** Local database reflects the initial schema.

*   **TODO 6.6:** Document the migration workflow.
    *   **File:** `docs/development/database-migrations.md` (or similar).
    *   **Content:** Explain how to create new migrations, apply them, and handle rollbacks using Supabase CLI.
    *   **Verification:** Documentation is clear and accessible.

---

### **Phase 3: Application Integration**

#### **7. Backend Integration (NestJS Supabase module/service)**

*   **TODO 7.1:** Create a NestJS Supabase module.
    *   **File:** `backend/src/supabase/supabase.module.ts`.
    *   **Code:** Define a module to encapsulate Supabase client creation and configuration.
    *   **Verification:** Module is created.

*   **TODO 7.2:** Create a NestJS Supabase service.
    *   **File:** `backend/src/supabase/supabase.service.ts`.
    *   **Code:** Implement a service that initializes and provides the Supabase client (`createClient`). Use `ConfigService` to inject `SUPABASE_URL` and `SUPABASE_ANON_KEY`.
    *   **Verification:** Service is created and injects config.

*   **TODO 7.3:** Integrate `SupabaseModule` into `AppModule`.
    *   **File:** `backend/src/app.module.ts`.
    *   **Code:** Import `SupabaseModule` and ensure `ConfigModule` is loaded first.
    *   **Verification:** `SupabaseModule` is available throughout the application.

*   **TODO 7.4:** Implement initial authentication logic using `SupabaseService`.
    *   **File:** `backend/src/auth/auth.service.ts` (create if not existing).
    *   **Code:** Add methods for sign-up, sign-in using `supabase.auth.signUp()` and `supabase.auth.signInWithPassword()`.
    *   **Verification:** Basic auth endpoints can be tested.

#### **8. Frontend Integration (Next.js Supabase client)**

*   **TODO 8.1:** Install Supabase JS client library in `frontend`.
    *   **Details:** Navigate to `frontend/` directory and run `pnpm add @supabase/supabase-js`.
    *   **Verification:** Package is installed.

*   **TODO 8.2:** Create a Supabase client utility.
    *   **File:** `frontend/lib/supabase/client.ts`.
    *   **Code:**
        ```typescript
        import { createBrowserClient } from '@supabase/ssr'

        export function createClient() {
          return createBrowserClient(
            process.env.NEXT_PUBLIC_SUPABASE_URL!,
            process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!
          )
        }
        ```
    *   **Verification:** Utility function is created.

*   **TODO 8.3:** Update `next.config.mjs` to expose Supabase environment variables.
    *   **File:** `next.config.mjs` (in project root, or `frontend/next.config.js`).
    *   **Code:** Add `NEXT_PUBLIC_SUPABASE_URL` and `NEXT_PUBLIC_SUPABASE_ANON_KEY` to `env` configuration if not already configured via other means (e.g., automatic Next.js env loading).
    *   **Verification:** Supabase env vars are accessible on the client side.

*   **TODO 8.4:** Implement basic sign-up/sign-in UI.
    *   **File:** `frontend/app/login/page.tsx` (or similar).
    *   **Code:** Use the `createClient()` utility to interact with Supabase for user authentication.
    *   **Verification:** Users can interact with the login UI.

---

### **Phase 4: Documentation Updates**

#### **9. Documentation Updates**

*   **TODO 9.1:** Update `README.md` with Supabase setup instructions.
    *   **File:** `/README.md` (project root).
    *   **Content:** Add a section on Supabase setup, including environment variables, and how to start local Supabase services if needed.
    *   **Verification:** `README.md` is updated.

*   **TODO 9.2:** Create/Update `docs/architecture.md` to reflect Supabase integration.
    *   **File:** `docs/architecture.md`.
    *   **Content:** Detail Supabase's role in the overall architecture, data flow, and security considerations.
    *   **Verification:** Architecture document reflects changes.

---

### **Final Checklist: Mapping TODOs to Acceptance Criteria**

This checklist ensures all Acceptance Criteria (ACs) from the S-1.3 story are met by the corresponding TODO items.

*   **AC1: Supabase Project Accessibility**
    *   ✅ TODO 1.1: Create a new Supabase project via the Supabase dashboard.
    *   ✅ TODO 1.2: Retrieve project identifier and connection string.
    *   ✅ TODO 1.4: Configure project settings.

*   **AC2: Environment Variable Configuration**
    *   ✅ TODO 2.1: Add `SUPABASE_URL` and `SUPABASE_ANON_KEY` to `.env.local`.
    *   ✅ TODO 2.2: Document secure integration into CI/CD pipelines.
    *   ✅ TODO 7.2: NestJS Supabase service injects `SUPABASE_URL` and `SUPABASE_ANON_KEY`.
    *   ✅ TODO 8.3: Update `next.config.mjs` to expose Supabase environment variables.

*   **AC3: Authentication Functionality**
    *   ✅ TODO 3.1: Enable Email provider in Supabase Auth settings.
    *   ✅ TODO 3.2 (Optional): Integrate and configure social login providers.
    *   ✅ TODO 3.3: Customize email templates for authentication.
    *   ✅ TODO 7.4: Implement initial authentication logic using `SupabaseService`.
    *   ✅ TODO 8.4: Implement basic sign-up/sign-in UI.

*   **AC4: Initial Schema Integrity**
    *   ✅ TODO 4.1: Plan `public.profiles` table schema.
    *   ✅ TODO 4.2: Plan `public.departments` table schema.
    *   ✅ TODO 4.3: Plan `public.employees` table schema (if distinct).
    *   ✅ TODO 4.4: Plan `public.shift_reports` table schema.
    *   ✅ TODO 4.5: Plan `public.kpis` table schema.
    *   ✅ TODO 4.6: Create a single SQL script for initial schema creation.
    *   ✅ TODO 4.7: Apply the initial schema SQL script to the Supabase database.
    *   ✅ TODO 6.4: Generate the first migration script (`initial_schema`).

*   **AC5: Role-Level Security Enforcement**
    *   ✅ TODO 4.1, 4.2, 4.3, 4.4, 4.5: RLS enabled and policies defined for respective tables within schema plans.
    *   ✅ TODO 5.1: Review and refine RLS policies.
    *   ✅ TODO 5.2: Test RLS policies thoroughly.

*   **AC6: Migration Readiness**
    *   ✅ TODO 6.1: Install Supabase CLI.
    *   ✅ TODO 6.2: Initialize Supabase CLI.
    *   ✅ TODO 6.3: Link local Supabase project to the remote project.
    *   ✅ TODO 6.4: Generate the first migration script (`initial_schema`).
    *   ✅ TODO 6.5: Apply the migration to the local development database.
    *   ✅ TODO 6.6: Document the migration workflow.